# VacationManager v7.8.1

Система управління відпустками та табелем обліку робочого часу для університетської кафедри.

## Остання версія (v7.8.1) - Telegram бот та системний трей

### Про проект

**VacationManager** — гібридна екосистема (Desktop + Web + Telegram) для автоматизації кадрового діловодства кафедри університету.

### Основні функції

- Управління персоналом кафедри (з підтримкою кількох позицій на одного співробітника)
- Річний графік відпусток з візуальним плануванням
- Конструктор заяв з WYSIWYG-редактором та live preview
- Генерація PDF документів з українською морфологією (WeasyPrint + Jinja2)
- **Табель обліку робочого часу** — автоматична генерація табеля з усіма кодами відвідуваності
- **Web UI (React)** — сучасний веб-інтерфейс для співробітників та завідувача кафедри
- **Web portal** для завантаження сканів підписаних документів
- **Telegram бот** для управління документами з мобільного пристрою
- **Системний трей** — фонова робота сервісів при закритому додатку
- WebSocket синхронізація між Desktop та Web
- **Повний workflow підписання документів**: заявник → диспетчерська → завідувач → наказ → ректор
- **ПІБ у давальному відмінку** — автоматична генерація для документів з можливістю ручного редагування
- **Контроль дат контракту** — відмітки про відвідування додаються лише на період дії контракту/заяви/конкурсу

### Технологічний стек

**Backend:**
- Python 3.10+, FastAPI, SQLAlchemy 2.0, Alembic
- JWT Auth (bcrypt), WebSocket support
- SQLite database

**Frontend (WebUI):**
- React 18, TypeScript, Vite
- Zustand (state management)
- Axios (HTTP client)

**Desktop:**
- PyQt6, PyQt6-WebEngine

**Telegram:**
- Aiogram 3.x (async Telegram bot framework)
- FSM (Finite State Machine) для діалогів
- Inline keyboards для навігації

**Document Generation:**
- WeasyPrint (HTML to PDF), Jinja2 templates

**Grammar & Logging:**
- pymorphy3 (Ukrainian morphology), structlog

---

## Останні оновлення (січень 2026)

### v7.8.1 - Telegram бот та системний трей

**Інтеграція Telegram бота:**
- **Aiogram 3.x бот:** Повноцінний Telegram бот для управління документами
- **Команди:** /start, /help, /search (для адміністраторів)
- **Головне меню:** Мої документи, Сьогоднішні, Проблемні, Профіль, Допомога
- **Перегляд документів:** Перегляд документів з пагінацією (5 на сторінку)
- **Сортування за місяцем/роком:** Групування документів за місяцем/роком
- **Застарілі документи:** Пояснення затримок для застарілих документів
- **Прив'язка акаунту:** Система запитів на прив'язку Telegram акаунту
- **Адміністративний пошук:** Пошук співробітників за ПІБ (з підтримкою кількох позицій)
- **Очищення чату:** Автоматичне очищення чату при нових запитах
- **Один екземпляр:** Заборона запускати кілька екземплярів бота

**Підтримка системного трею:**
- **Фонові сервіси:** Backend, Telegram бот та Web UI продовжують працювати при закритому desktop
- **Іконка в треї:** Іконка в системному треї з контекстним меню
- **Дії меню:** Показати/Приховати, Відкрити Web Portal, Вийти
- **Мінімізація в трей:** Закриття вікна мінімізує в трей замість виходу
- **Режим тільки трей:** Можливість запуску без вікна (--tray-only)
- **Один екземпляр:** Виявлення вже запущеного додатку через локальний сокет
- **Керування сервісами:** Автоматичний запуск/зупинка backend та web UI

**Покращення Desktop UI:**
- **Вкладка Персонал:** Видалено dropdown фільтр активності
- **Вкладка Графік:** Приховано вкладку "Графік відпусток" (збережено для внутрішнього використання)
- **Налаштування:** Об'єднано вкладки Форматування, Відпустки та Табель в одну "Табель"
- **Налаштування:** Видалено emojis з інтерфейсу налаштувань
- **Telegram права:** Додано адміністративний доступ для перегляду всіх документів

**Покращення Web UI:**
- **Telegram налаштування:** Сторінка управління запитами на прив'язку Telegram
- **Статус прив'язки:** Індикація статусу прив'язки в картці співробітника
- **Пагінація документів:** Покращена пагінація документів з сортуванням за місяцем/роком

**Міграції бази даних:**
- **Telegram поля:** telegram_user_id, telegram_username, telegram_permissions в таблиці staff
- **Лічильник блокувань:** stale_lock_count в таблиці documents для відстеження блокувань
- **Запити на прив'язку:** Таблиця telegram_link_requests для обліку запитів на прив'язку

**Документація:**
- **TELEGRAM_SETUP.md:** Інструкція з налаштування Telegram бота
- **BotFather гід:** Покрокова інструкція створення бота
- **Webhook режим:** Підтримка ngrok для webhook режиму

### v7.7.4 - Виправлення та покращення табеля

**Виправлення:**
- **Кнопка погодження:** Виправлено баг, коли кнопка погодження табеля залишалася активною після погодження
  - Кнопка тепер коректно приховується для звичайних та корегуючих табелів
  - Виправлено логіку `is_generated and not is_approved`
- **Розрахунок годин:** Виправлено збереження позицій для розрахунку годин
  - Раніше зберігалися українські мітки ("Фахівець"), зараз — значення enum ("specialist")

**Покращення табеля:**
- **Візуальні індикатори:** Додано візуальні індикатори для погоджених корегуючих табелів (червона рамка)
- **Кнопка закриття:** Прихована на погоджених корегуючих табелях
- **Авто-оновлення:** Корегуючі табелі автоматично оновлюються при відкритті вкладки
- **Архівування:** Архіви табелів тепер містять повні сирі дані

**Документи про прийом:**
- **Нові шаблони:** Додано шаблони для документів про прийом на роботу

**Web UI:**
- **Модальне вікно:** Додано модальне вікно для вирішення проблем застарілих документів
- **Українська локаль:** Додано українську локізацію для antd компонентів

### v7.7.3 - Моніторинг застарілих документів та масові операції

**Моніторинг застарілих документів:**
- **Поля бази даних:** Додано поля `status_changed_at`, `stale_notification_count`, `stale_explanation`
- **StaleDocumentService:** Сервіс для моніторингу документів, статус яких не змінювався більше 1 дня
- **Автоматичне виявлення:** Виявлення застарілих документів з керованими статусами
- **Система сповіщень:** Лічильник сповіщень з лімітом (3)
- **Дії вирішення:** Можливість пояснити затримку або видалити документ

**Масові операції з документами:**
- **Валідація:** `/api/bulk/validate` — перевірка можливості масового створення
- **Генерація:** `/api/bulk/generate` — масове створення документів
- **Перевірка:** Перевірка конфліктів дат, активності співробітників
- **Доступ:** Можливості доступні лише завідувачам кафедри

### v7.7.1 - Документи про прийом на роботу

**Система документів про прийом:**
- **Нові типи:** employment_contract, employment_competition, employment_pdf
- **Шаблони:** HTML шаблони для генерації документів про прийом
- **Створення співробітників:** Автоматичне створення при завантаженні скану

### v7.4.5 - Новий WebUI та розширене API

**Повноцінний React/TypeScript WebUI:**
- React 18 з TypeScript та Vite
- Zustand state management
- **Сторінки:** Dashboard, Staff, Documents, Schedule, Settings, Auth
- **Компоненти:** Header, Sidebar, MainLayout

**Нові API routes:**
- `/auth` — JWT автентифікація
- `/attendance` — керування відвідуваністю
- `/dashboard` — агрегована статистика
- `/settings` — налаштування додатку
- `/tabel` — генерація та управління табелями

---

## Встановлення

### Клонування репозиторію

```bash
git clone <repository-url>
cd VacationManager
```

### Створення віртуального середовища

```bash
python -m venv venv

# Windows
venv\Scripts\activate

# Linux/Mac
source venv/bin/activate
```

### Встановлення залежностей

```bash
pip install -r requirements.txt
```

### Налаштування

```bash
copy .env.example .env
```

Відредагуйте `.env` при необхідності.

## Використання

### Ініціалізація бази даних

```bash
# Створення міграції
alembic revision --autogenerate -m "опис"

# Застосування міграцій
alembic upgrade head
```

### Запуск сервера

```bash
# Запуск всього (backend + web)
python run.py --all

# Запуск тільки backend
python run.py --backend

# Запуск desktop з системним треєм
python run.py --tray

# Запуск desktop в режимі тільки трей
python -m desktop --tray-only
```

### Запуск WebUI (React)

```bash
cd web
npm install
npm run dev
```

WebUI буде доступно за адресою: http://localhost:5173

### Запуск Desktop додатку

```bash
python -m desktop
```

### Запуск Telegram бота

```bash
# Polling режим (для розробки)
python run.py --telegram

# Webhook режим з ngrok
python run.py --telegram-webhook
```

## Тестування

```bash
# Запуск всіх тестів
pytest

# Запуск з покриттям
pytest --cov=backend --cov=desktop
```

## Структура проекту

```
VacationManager/
├── backend/                # FastAPI backend
│   ├── core/              # Config, Database, Security, Logging
│   ├── models/            # SQLAlchemy ORM models
│   ├── telegram/          # Telegram bot
│   ├── schemas/           # Pydantic schemas
│   ├── services/          # Business logic
│   └── api/routes/        # FastAPI endpoints
├── web/                   # React WebUI
├── desktop/               # PyQt6 Desktop application
│   ├── ui/                # UI components
│   ├── utils/             # Utility modules
│   │   └── system_tray.py # System tray manager
│   └── widgets/           # Custom widgets
├── docs/                  # Documentation
│   └── TELEGRAM_SETUP.md  # Telegram bot setup guide
├── tests/
│   └── telegram/          # Telegram bot tests
└── run.py                 # Main entry point
```

## API Reference

Базовий URL: `http://127.0.0.1:8000/api`

### Ролі користувачів

| Роль | Опис | Права доступу |
|------|------|---------------|
| **admin** | Адміністратор | Повний доступ |
| **department_head** | Завідувач кафедри | Перегляд, редагування, затвердження |
| **employee** | Співробітник | Перегляд власних даних, створення заяв |

### Auth (`/auth`)

| Метод | Endpoint | Auth | Опис |
|--------|----------|------|-----|
| POST | `/login` | - | Автентифікація |
| POST | `/logout` | ✓ | Вихід |
| POST | `/refresh` | - | Оновлення токена |
| GET | `/me` | ✓ | Інформація про користувача |

### Staff (`/staff`)

| Метод | Endpoint | Auth | Опис |
|--------|----------|------|-----|
| GET | `/` | ✓ | Список співробітників |
| GET | `/{id}` | Head | Деталі співробітника |
| POST | `/` | Admin | Створити співробітника |
| PUT | `/{id}` | Head | Оновити співробітника |
| DELETE | `/{id}` | Admin | Видалити |
| GET | `/{id}/documents` | ✓ | Документи співробітника |

### Documents (`/documents`)

| Метод | Endpoint | Auth | Опис |
|--------|----------|------|-----|
| GET | `/` | ✓ | Список документів |
| GET | `/{id}` | ✓ | Деталі документа |
| POST | `/` | ✓ | Створити документ |
| POST | `/{id}/upload-scan` | ✓ | Завантажити скан |

### Telegram (`/telegram`)

| Метод | Endpoint | Auth | Опис |
|--------|----------|------|-----|
| POST | `/link-request` | ✓ | Запит на прив'язку |
| GET | `/link-requests` | Head | Список запитів |
| POST | `/approve/{id}` | Head | Погодити запит |
| POST | `/reject/{id}` | Head | Відхилити запит |

## Код-стайл

- **PEP 8** форматування (black)
- **Google Style** docstrings
- Коментарі українською мовою
- Type hints обов'язкові
- DRY, SOLID, Clean Architecture

## Ліцензія

© 2025-2026 VacationManager v7.8.1

---

## Версіювання

| Версія | Дата | Зміни |
|--------|------|-------|
| v7.8.1 | Січень 2026 | **Telegram Bot**, **System Tray**, прив'язка акаунтів |
| v7.7.4 | Січень 2026 | Виправлення та покращення табеля |
| v7.7.3 | Січень 2026 | Моніторинг застарілих документів, масові операції |
| v7.7.1 | Січень 2026 | Документи про прийом, валідація ПІБ |
| v7.4.5 | Січень 2026 | Повноцінний WebUI (React/TS) |
| v7.2.0 | Січень 2026 | Покращена архівація, ПІБ у давальному відмінку |
| v7.0 | Січень 2026 | Web UI, JWT Auth, REST API |
| v6.0 | Січень 2026 | Табель обліку, Attendance |
| v5.0 | 2025 | Базова функціональність |
