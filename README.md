# VacationManager v6.0

Система управління відпустками та табелем обліку робочого часу для університетської кафедри.

## Версія Latest (v6.0) - Табель обліку та Відповідний Workflow

### Проект

**VacationManager** — гібридна екосистема (Desktop + Web) для автоматизації кадрового діловодства кафедри університету.

### Основні функції

- Управління персоналом кафедри (з підтримкою кількох позицій на одного співробітника)
- Річний графік відпусток з візуальним плануванням
- Конструктор заяв з WYSIWYG-редактором та live preview
- Генерація PDF документів з українською морфологією (WeasyPrint + Jinja2)
- **Табель обліку робочого часу** — автоматична генерація табеля з усіма кодами відвідуваності
- Web portal для завантаження сканів підписаних документів
- WebSocket синхронізація між Desktop та Web
- **Повний workflow підписання документів**: заявник → диспетчерська → завідувач → наказ → ректор
- **ПІБ у давальному відмінку** — автоматична генерація для документів з можливістю ручного редагування
- **Контроль дат контракту** — відмітки про відвідування додаються лише на період дії контракту/заяви/конкурсу

### Технологічний стек

- **Backend**: Python 3.10+, FastAPI, SQLAlchemy 2.0, Alembic
- **Desktop**: PyQt6, PyQt6-WebEngine
- **Database**: SQLite
- **Document Generation**: WeasyPrint (HTML to PDF), Jinja2 templates
- **Grammar**: pymorphy3 (Ukrainian morphology)
- **Logging**: structlog

---

## Останні оновлення (січень 2026)

### Major Changes

#### 1. Контроль дат контракту
Валідація періоду дії працівника при додаванні відміток:

- **AttendanceConflictError** — новий тип виключення для конфліктів дат
- **check_conflicts()** — перевірка накладання періодів відвідування
- Валідація в _on_add_absence() та _on_edit_absence()
- Динамічні повідомлення залежно від основи роботи (контракт/конкурс/заява)
- Відмітки поза межами контракту відображаються закресленими в табелі

#### 2. ПІБ у давальному відмінку
Генерація та збереження давального відмінка для документів:

- **pib_dav** — нове поле в моделі Staff
- **GrammarService.to_dative()** — автоматична генерація давального відмінка
- UI в картці працівника з кнопками "Згенерувати" та "Зберегти"
- Підтвердження результату з можливістю ручного редагування

#### 3. Табель обліку робочого часу (TabelService)
Повноцінна система генерації табеля згідно з наказом Мінпраці №55:

**`tabel_service.py`** (30KB) — сервіс генерації табеля:
- Автоматичний розрахунок робочих днів та годин за місяць
- Підтримка всіх літерних кодів відвідуваності (Р, В, ВД, ТН, тощо)
- Розрахунок підсумків по півмісяцях та за місяць
- Підтримка надурочних годин (НУ), нічних (РН), вечірніх (ВЧ), вихідних (РВ)
- Генерація HTML з Jinja2 шаблоном
- Пагінація (кількість працівників на сторінці)
- **Контрактні межі** — дні до початку та після закінчення контракту:
  - Відображаються порожніми з суцільною лінією
  - З'єднання ліній між комірками та між рядками
  - Вихідні дні НЕ отримують лінію (порожні як зазвичай)
- **Деактивовані працівники** — виключаються з табеля наступного місяця
- Підсумки відсутностей за категоріями:
  - Відпустки 8-10 днів (вак_8_10)
  - Відпустки 11-15 днів (вак_11_15)
  - Відпустки 18 днів (вак_18)
  - Відпустки 19 днів (вак_19)
  - Відрядження, неповний день, тощо

**`attendance.py`** — модель відвідуваності:
- Повний список кодів згідно з наказом Мінпраці №55 (30+ кодів)
- Літерний код → числовий код (наприклад, Р → 01)
- Підтримка діапазонів дат (`date_end`)
- Properties для перевірки типу: `is_work_day`, `is_vacation`, `is_sick_leave`, тощо

#### 2. Attendance Tracking (AttendanceService)
**`attendance_service.py`** (8KB) — CRUD для записів відвідуваності:
- `create_attendance()` — створення запису на один день
- `create_attendance_range()` — створення діапазону дат
- `get_staff_attendance()` — отримання за місяць/рік
- `update_attendance()`, `delete_attendance()`, `delete_attendance_range()`
- Автоматичне оновлення існуючих записів при дублюванні

#### 3. Staff History Tracking
**`staff_history.py`** — модель історії змін співробітників:
- Відстеження всіх змін (CREATE, UPDATE, DEACTIVATE, RESTORE)
- JSON зі старими значеннями (тільки змінені поля)
- `changed_by` — хто вніс зміни
- `comment` — коментар до зміни

#### 4. Shared Absence Types
**`absence_types.py`** — централізовані типи відсутностей для UI:
- Групи типів з українськими назвами
- Маппінг назв → код (CODE_TO_ABSENCE_NAME)
- Коди що вимагають вказання годин (CODES_REQUIRING_HOURS)

#### 5. WeasyPrint замість docxtpl
- HTML → PDF замість Word → PDF
- Jinja2 шаблони в `desktop/templates/tabel/`
- Краща підтримка української мови та шрифтів

#### 6. Вдосконалений Workflow
Повний ланцюжок підписання:
1. **Draft** — чернетка заявки
2. **On Signature** — на підписі (до 3 відпусток, 1 контракт)
3. **Signed** — підписано всіма
4. **Processed** — оброблено (дні списано, додано до табеля)

#### 7. Структурне логування (structlog)
- JSON або консольний формат
- Рівні: DEBUG, INFO, WARNING, ERROR, CRITICAL
- Контекстне логування для кращої дебаг-інформації

#### 8. Українська морфологія
**`grammar_service.py`** — розширений сервіс морфології:
- **to_dative()** — давальний відмінок ПІБ (для документів)
- to_genitive() — родовий відмінок
- to_accusative() — знахідний відмінок (підготовлено)
- decline_position() — відмінювання посад

#### 9. Нові виключення
**`shared/exceptions.py`**:
- **AttendanceConflictError** — конфлікт дат у відвідуванні
- GrammarError — помилки морфології

### Оновлені Константи

** Ukrainian Attendance Codes (наказ Мінпраці №55)**
```
# Явки на роботу
Р = "01"  # Години роботи за договором
РС = "20" # Неповний робочий день
ВЧ = "03" # Вечірні години
РН = "04" # Нічні години
НУ = "05" # Надурочні години
РВ = "06" # Робота у вихідні/святкові

# Відрядження
ВД = "10" # Службове відрядження

# Відпустки оплачувані
В = "08"  # Основна щорічна
Д = "09"  # Додаткова щорічна
Ч = "11"  # Чорнобильцям
ТВ = "12" # Творча відпустка
Н = "13"  # У зв'язку з навчанням
ДО = "16" # З дітьми
ВП = "17" # Вагітність/догляд до 3 років
ДД = "18" # Догляд за дитиною до 6 років

# Відпустки без зарплати
НБ = "14" # У зв'язку з навчанням
ДБ = "15" # Обов'язкова без збереження
НА = "21" # За згодою сторін
БЗ = "22" # Інші без зарплати

# Неявки
НД = "20" # Неповний робочий день
НП = "21" # Тимчасовий переклад
ІН = "22" # Інший невідпрацьований час
П = "23"  # Простої
ПР = "24" # Прогули
С = "25"  # Страйки

# Тимчасова непрацездатність
ТН = "26" # Оплачувана
НН = "27" # Неоплачувана

# Інші причини
НЗ = "28" # Нез'ясовані причини
ІВ = "29" # Інші види за колдоговором
І = "30"  # Інші причини
```

### Нові Моделі / Оновлені Моделі

```
backend/models/
├── attendance.py     # відмітки про явки/неявки
├── staff.py          # ОНОВЛЕНО: +pib_dav (давальний відмінок)
├── staff_history.py  # історія змін співробітників
```

### Нові Сервіси

```
backend/services/
├── attendance_service.py  # НОВЕ - CRUD для відвідуваності
├── tabel_service.py       # НОВЕ - генерація табеля (30KB)
```

### Оновлені Schemas

```
backend/schemas/
├── attendance.py    # НОВЕ - схеми для відвідуваності
├── tabel.py         # НОВЕ - схеми для табеля
```

---

## Встановлення

### Клонування репозиторію

```bash
git clone <repository-url>
cd VacationManager
```

### Створення віртуального середовища

```bash
python -m venv venv

# Windows
venv\Scripts\activate

# Linux/Mac
source venv/bin/activate
```

### Встановлення залежностей

```bash
pip install -r requirements.txt
```

### Налаштування

```bash
copy .env.example .env
```

Відредагуйте `.env` при необхідності.

## Використання

### Ініціалізація бази даних

```bash
# Створення міграції
alembic revision --autogenerate -m "description"

# Застосування міграцій
alembic upgrade head
```

### Запуск Web сервера

```bash
python -m backend.main
```

API буде доступно за адресою: http://127.0.0.1:8000

- Документація API: http://127.0.0.1:8000/docs
- Upload Portal: http://127.0.0.1:8000/upload-portal

### Запуск Desktop додатку

```bash
python -m desktop.main
```

### Генерація табеля

```python
from backend.services.tabel_service import generate_tabel_html

# Генерація HTML для січня 2026
html = generate_tabel_html(month=1, year=2026)

# Збереження у файл
from backend.services.tabel_service import save_tabel_to_file
filepath = save_tabel_to_file(html, month=1, year=2026)
```

## Тестування

```bash
# Запуск всіх тестів
pytest

# Запуск unit тестів
pytest tests/unit

# Запуск integration тестів
pytest tests/integration

# Запуск з покриттям
pytest --cov=backend --cov=desktop
```

## Якість коду

```bash
# Форматування коду
black .

# Перевірка стилів
ruff check .

# Перевірка типів
mypy .
```

## Структура проекту

```
VacationManager/
├── backend/                # FastAPI backend
│   ├── core/              # Config, Database, Logging (structlog)
│   ├── models/            # SQLAlchemy ORM models
│   │   ├── base.py
│   │   ├── staff.py          # +pib_dav
│   │   ├── document.py
│   │   ├── schedule.py
│   │   ├── settings.py
│   │   ├── attendance.py  # НОВЕ
│   │   └── staff_history.py  # НОВЕ
│   ├── schemas/           # Pydantic schemas
│   │   ├── schedule.py
│   │   ├── responses.py
│   │   ├── staff.py
│   │   ├── document.py
│   │   ├── attendance.py  # НОВЕ
│   │   └── tabel.py       # НОВЕ
│   ├── services/          # Business logic
│   │   ├── grammar_service.py
│   │   ├── validation_service.py
│   │   ├── document_service.py
│   │   ├── bulk_document_service.py
│   │   ├── schedule_service.py
│   │   ├── staff_service.py
│   │   ├── date_parser.py
│   │   ├── attendance_service.py  # НОВЕ
│   │   └── tabel_service.py       # НОВЕ
│   ├── api/
│   │   ├── routes/        # FastAPI endpoints
│   │   │   ├── documents.py
│   │   │   ├── staff.py
│   │   │   ├── schedule.py
│   │   │   ├── upload.py
│   │   │   ├── attendance.py  # НОВЕ
│   │   │   └── tabel.py       # НОВЕ
│   │   └── dependencies.py
│   ├── static/            # CSS, JS для upload portal
│   └── templates/         # HTML templates для web
├── desktop/               # PyQt6 Desktop application
│   ├── ui/                # UI components
│   ├── widgets/           # Custom widgets
│   │   ├── status_badge.py
│   │   └── live_preview.py
│   ├── templates/         # Jinja2 templates для PDF
│   │   └── tabel/         # НОВЕ - шаблони табеля
│   └── utils/             # Utilities
├── shared/                # Shared code
│   ├── enums.py
│   ├── constants.py
│   ├── validators.py
│   ├── exceptions.py
│   └── absence_types.py   # НОВЕ
├── storage/               # Generated documents and scans
│   └── tabels/            # НОВЕ - згенеровані табелі
├── tests/
│   ├── unit/
│   └── integration/
└── alembic/               # Database migrations
```

## Документообіг

### Статуси документів

```
Draft → On Signature → Signed → Processed
```

### Workflow підписання

1. **Заявник** - створює та підписує заяву
2. **Диспетчерська** - перевіряє та погоджує
3. **Завідувач кафедри** - підписує
4. **Наказ** - реєструє наказ
5. **Ректор** - фінальне підписання
6. **Сканування** - завантаження скану
7. **Табель** - автоматичне додавання до табеля обліку

### Літерні коди табеля

Повний список кодів згідно з наказом Мінпраці №55:
- **Р** — робочі дні
- **В** — щорічна відпустка
- **ВД** — відрядження
- **ТН** — тимчасова непрацездатність (лікарняний)
- **НУ** — надурочні години
- **РН** — нічні години
- **ВЧ** — вечірні години
- **РВ** — робота у вихідні
- [та багато інших...]

## Код-стайл

- **PEP 8** форматування (black)
- **Google Style** docstrings
- Коментарі українською мовою
- Type hints обов'язкові
- DRY, SOLID, Clean Architecture

## Ліцензія

© 2025-2026 VacationManager v6.0

---

## Версіювання

| Версія | Дата | Зміни |
|--------|------|-------|
| v6.0 | Січень 2026 | Табель обліку, Attendance Tracking, Workflow |
| v5.0 | 2025 | Базова функціональність |


