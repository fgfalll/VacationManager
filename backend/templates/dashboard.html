<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VacationManager - –ö–∞–±—ñ–Ω–µ—Ç —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card.warning {
            background: #FFF3E0;
            border-left: 4px solid #FF9800;
        }

        .stat-card.danger {
            background: #FFEBEE;
            border-left: 4px solid #F44336;
        }

        .stat-card.success {
            background: #E8F5E9;
            border-left: 4px solid #4CAF50;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .schedule-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #3B82F6;
        }

        .schedule-item.used {
            border-left-color: #4CAF50;
            opacity: 0.7;
        }

        .schedule-dates {
            font-weight: bold;
            color: #333;
        }

        .schedule-days {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .schedule-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-top: 10px;
        }

        .status-planned {
            background: #E3F2FD;
            color: #1976D2;
        }

        .status-used {
            background: #E8F5E9;
            color: #388E3C;
        }

        .contract-info {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .contract-info.warning {
            background: #FFF3E0;
            border: 2px solid #FF9800;
        }

        .contract-info.danger {
            background: #FFEBEE;
            border: 2px solid #F44336;
        }

        .expiry-days {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .expiry-days.warning {
            color: #FF9800;
        }

        .expiry-days.danger {
            color: #F44336;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .nav-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .nav-tab:hover {
            color: #3B82F6;
        }

        .nav-tab.active {
            color: #3B82F6;
            border-bottom-color: #3B82F6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .progress-bar {
            height: 20px;
            background: #E0E0E0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s;
        }

        .document-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .document-info h4 {
            margin: 0 0 5px 0;
        }

        .document-meta {
            color: #666;
            font-size: 14px;
        }

        .document-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-draft { background: #E3F2FD; color: #1976D2; }
        .badge-on-signature { background: #FFF3E0; color: #F57C00; }
        .badge-signed { background: #E8F5E9; color: #388E3C; }
        .badge-processed { background: #ECEFF1; color: #455A64; }

        /* Workflow Progress Styles */
        .workflow-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .workflow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .workflow-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .workflow-toggle {
            color: #666;
            font-size: 14px;
        }

        .workflow-steps {
            display: none;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .workflow-steps.expanded {
            display: block;
        }

        .workflow-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 6px;
            background: #f9f9f9;
        }

        .workflow-step.completed {
            background: #E8F5E9;
            border-left: 3px solid #4CAF50;
        }

        .workflow-step.pending {
            background: #FFFDE7;
            border-left: 3px solid #FFC107;
        }

        .workflow-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 14px;
            flex-shrink: 0;
        }

        .workflow-step.completed .workflow-icon {
            background: #4CAF50;
            color: white;
        }

        .workflow-step.pending .workflow-icon {
            background: #FFC107;
            color: white;
        }

        .step-content {
            flex: 1;
        }

        .step-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .step-date {
            font-size: 12px;
            color: #666;
        }

        .step-comment {
            font-size: 13px;
            color: #555;
            margin-top: 4px;
            font-style: italic;
        }

        .document-dates {
            color: #666;
            font-size: 14px;
            margin-top: 4px;
        }

        .action-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .action-btn.upload {
            background: #3B82F6;
            color: white;
        }

        .action-btn.view {
            background: #E0E0E0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üë§ –ö–∞–±—ñ–Ω–µ—Ç —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞</h1>
            <p class="subtitle">–ü–µ—Ä–µ–≥–ª—è–¥ –±–∞–ª–∞–Ω—Å—É, –≥—Ä–∞—Ñ—ñ–∫—É —Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤</p>
        </header>

        <main class="main">
            <!-- Employee Selection -->
            <section class="card">
                <div class="card-header">
                    <h2>–í–∏–±–µ—Ä—ñ—Ç—å —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞</h2>
                </div>
                <div class="card-body">
                    <select id="staff-select" class="form-control" onchange="loadEmployeeData()">
                        <option value="">-- –û–±–µ—Ä—ñ—Ç—å —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ --</option>
                    </select>
                </div>
            </section>

            <!-- Dashboard Content (hidden until staff selected) -->
            <div id="dashboard-content" style="display: none;">
                <!-- Stats Cards -->
                <div class="dashboard-grid">
                    <div class="stat-card" id="vacation-balance-card">
                        <div class="stat-label">üèñÔ∏è –ó–∞–ª–∏—à–æ–∫ –¥–Ω—ñ–≤ –≤—ñ–¥–ø—É—Å—Ç–∫–∏</div>
                        <div class="stat-value" id="vacation-balance">0</div>
                        <div class="stat-label">–¥–Ω—ñ–≤ –¥–æ—Å—Ç—É–ø–Ω–æ</div>
                    </div>

                    <div class="stat-card" id="used-days-card">
                        <div class="stat-label">‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –∑–∞ —Ä—ñ–∫</div>
                        <div class="stat-value" id="used-days">0</div>
                        <div class="stat-label">–¥–Ω—ñ–≤ –≤—ñ–¥–ø—É—Å—Ç–∫–∏</div>
                    </div>

                    <div class="stat-card" id="contract-card">
                        <div class="stat-label">üìã –ö–æ–Ω—Ç—Ä–∞–∫—Ç</div>
                        <div class="stat-value" id="contract-days">0</div>
                        <div class="stat-label">–¥–Ω—ñ–≤ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è</div>
                    </div>
                </div>

                <!-- Navigation Tabs -->
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('schedule')">üìÖ –ì—Ä–∞—Ñ—ñ–∫</button>
                    <button class="nav-tab" onclick="showTab('documents')">üìÑ –î–æ–∫—É–º–µ–Ω—Ç–∏</button>
                    <button class="nav-tab" onclick="showTab('upload')">üì§ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–∫–∞–Ω</button>
                </div>

                <!-- Schedule Tab -->
                <div id="tab-schedule" class="tab-content active">
                    <section class="card">
                        <div class="card-header">
                            <h2>–ü–ª–∞–Ω–æ–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–ø—É—Å—Ç–æ–∫ –Ω–∞ <span id="schedule-year">2025</span></h2>
                        </div>
                        <div class="card-body">
                            <div id="schedule-list"></div>
                        </div>
                    </section>
                </div>

                <!-- Documents Tab -->
                <div id="tab-documents" class="tab-content">
                    <section class="card">
                        <div class="card-header">
                            <h2>–ú–æ—ó –¥–æ–∫—É–º–µ–Ω—Ç–∏</h2>
                        </div>
                        <div class="card-body">
                            <div id="documents-list"></div>
                        </div>
                    </section>
                </div>

                <!-- Upload Tab -->
                <div id="tab-upload" class="tab-content">
                    <section class="card">
                        <div class="card-header">
                            <h2>–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–∫–∞–Ω –ø—ñ–¥–ø–∏—Å–∞–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞</h2>
                        </div>
                        <div class="card-body">
                            <div id="pending-upload-list"></div>
                        </div>
                    </section>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>VacationManager v6.0 ¬© 2025</p>
        </footer>
    </div>

    <script>
        const API_BASE = '/api';
        let currentStaffId = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadStaffList();
        });

        async function loadStaffList() {
            try {
                const response = await fetch(`${API_BASE}/staff`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');

                const data = await response.json();
                const select = document.getElementById('staff-select');

                data.items.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff.id;
                    option.textContent = staff.pib_nom;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading staff:', error);
            }
        }

        async function loadEmployeeData() {
            const select = document.getElementById('staff-select');
            currentStaffId = select.value;

            if (!currentStaffId) {
                document.getElementById('dashboard-content').style.display = 'none';
                return;
            }

            document.getElementById('dashboard-content').style.display = 'block';

            // Load all data in parallel
            await Promise.all([
                loadStaffInfo(),
                loadSchedule(),
                loadDocuments(),
                loadPendingUploads()
            ]);
        }

        async function loadStaffInfo() {
            try {
                const response = await fetch(`${API_BASE}/staff/${currentStaffId}`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞');

                const staff = await response.json();

                // Update vacation balance
                document.getElementById('vacation-balance').textContent = staff.vacation_balance;

                // Calculate used days from documents
                const docsResponse = await fetch(`${API_BASE}/documents?staff_id=${currentStaffId}`);
                const docsData = await docsResponse.json();
                const usedDays = docsData.items
                    .filter(d => d.status === 'processed' && d.doc_type === 'vacation_paid')
                    .reduce((sum, d) => sum + d.days_count, 0);
                document.getElementById('used-days').textContent = usedDays;

                // Update contract info
                const daysUntilExpiry = Math.floor((new Date(staff.term_end) - new Date()) / (1000 * 60 * 60 * 24));
                const contractCard = document.getElementById('contract-card');
                const contractDays = document.getElementById('contract-days');

                contractDays.textContent = daysUntilExpiry;

                contractCard.classList.remove('warning', 'danger', 'success');
                if (daysUntilExpiry < 0) {
                    contractCard.classList.add('danger');
                    contractDays.classList.add('danger');
                } else if (daysUntilExpiry <= 30) {
                    contractCard.classList.add('warning');
                    contractDays.classList.add('warning');
                } else {
                    contractCard.classList.add('success');
                }

            } catch (error) {
                console.error('Error loading staff info:', error);
            }
        }

        async function loadSchedule() {
            try {
                const year = new Date().getFullYear();
                const response = await fetch(`${API_BASE}/schedule/${year}`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞');

                const data = await response.json();
                const staffSchedule = data.items.filter(s => s.staff_id == currentStaffId);

                const container = document.getElementById('schedule-list');
                document.getElementById('schedule-year').textContent = year;

                if (staffSchedule.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÖ</div>
                            <p>–ù–∞ ${year} —Ä—ñ–∫ –≥—Ä–∞—Ñ—ñ–∫ –Ω–µ —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–æ</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = staffSchedule.map(entry => `
                    <div class="schedule-item ${entry.is_used ? 'used' : ''}">
                        <div class="schedule-dates">
                            ${formatDate(entry.planned_start)} - ${formatDate(entry.planned_end)}
                        </div>
                        <div class="schedule-days">
                            ${(new Date(entry.planned_end) - new Date(entry.planned_start)) / (1000 * 60 * 60 * 24) + 1} –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–∏—Ö –¥–Ω—ñ–≤
                        </div>
                        <span class="schedule-status ${entry.is_used ? 'status-used' : 'status-planned'}">
                            ${entry.is_used ? '–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ' : '–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ'}
                        </span>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading schedule:', error);
                document.getElementById('schedule-list').innerHTML =
                    '<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—É</p>';
            }
        }

        async function loadDocuments() {
            try {
                const response = await fetch(`${API_BASE}/documents?staff_id=${currentStaffId}`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞');

                const data = await response.json();
                const container = document.getElementById('documents-list');

                if (data.items.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÑ</div>
                            <p>–î–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.items.map(doc => `
                    <div class="workflow-container">
                        <div class="workflow-header" onclick="toggleWorkflow(this)">
                            <div>
                                <div class="workflow-title">${getDocumentTypeLabel(doc.doc_type)}</div>
                                <div class="document-dates">
                                    ${formatDate(doc.date_start)} - ${formatDate(doc.date_end)} | ${doc.days_count} –¥–Ω—ñ–≤
                                </div>
                            </div>
                            <div>
                                <span class="document-badge badge-${doc.status}">
                                    ${getStatusLabel(doc.status)}
                                </span>
                                <span class="workflow-toggle">‚ñº</span>
                            </div>
                        </div>
                        <div class="workflow-steps" id="workflow-${doc.id}">
                            ${renderWorkflowSteps(doc.progress || getEmptyProgress())}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }

        function getEmptyProgress() {
            return {
                applicant: { completed: false, at: null, comment: null },
                approval: { completed: false, at: null, comment: null },
                department_head: { completed: false, at: null, comment: null },
                approval_order: { completed: false, at: null, comment: null },
                rector: { completed: false, at: null, comment: null },
                scanned: { completed: false, at: null, comment: null },
                tabel: { completed: false, at: null, comment: null },
            };
        }

        function renderWorkflowSteps(progress) {
            const steps = [
                { key: 'applicant', name: '–ü—ñ–¥–ø–∏—Å –≤–∏–∫–ª–∞–¥–∞—á–∞', icon: '‚úçÔ∏è' },
                { key: 'approval', name: '–ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ –¥–∏—Å–ø–µ—Ç—á–µ—Ä—Å—å–∫–æ—é', icon: 'üìã' },
                { key: 'department_head', name: '–ü—ñ–¥–ø–∏—Å –∑–∞–≤—ñ–¥—É–≤–∞—á–∞', icon: 'üëî' },
                { key: 'approval_order', name: '–ü—ñ–¥–ø–∏—Å–∞–Ω–æ –Ω–∞–∫–∞–∑–æ–º', icon: 'üìÑ' },
                { key: 'rector', name: '–ü—ñ–¥–ø–∏—Å —Ä–µ–∫—Ç–æ—Ä–∞', icon: 'üèõÔ∏è' },
                { key: 'scanned', name: '–í—ñ–¥—Å–∫–∞–Ω–æ–≤–∞–Ω–æ', icon: 'üì∑' },
                { key: 'tabel', name: '–î–æ–¥–∞–Ω–æ –¥–æ —Ç–∞–±–µ–ª—é', icon: '‚úÖ' },
            ];

            return steps.map(step => {
                const p = progress[step.key] || { completed: false, at: null, comment: null };
                const statusClass = p.completed ? 'completed' : 'pending';
                const icon = p.completed ? '‚úì' : '‚óã';
                const dateStr = p.at ? formatDateTime(p.at) : '–û—á—ñ–∫—É—î—Ç—å—Å—è';
                const commentHtml = p.comment ? `<div class="step-comment">${p.comment}</div>` : '';

                return `
                    <div class="workflow-step ${statusClass}">
                        <div class="workflow-icon">${icon}</div>
                        <div class="step-content">
                            <div class="step-name">${step.icon} ${step.name}</div>
                            <div class="step-date">${dateStr}</div>
                            ${commentHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleWorkflow(header) {
            const steps = header.nextElementSibling;
            const toggle = header.querySelector('.workflow-toggle');
            steps.classList.toggle('expanded');
            toggle.textContent = steps.classList.contains('expanded') ? '‚ñ≤' : '‚ñº';
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('uk-UA', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function loadPendingUploads() {
            try {
                const response = await fetch(`${API_BASE}/documents/pending?staff_id=${currentStaffId}`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞');

                const data = await response.json();
                const container = document.getElementById('pending-upload-list');

                if (data.items.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚úì</div>
                            <p>–ù–µ–º–∞—î –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –Ω–∞ –ø—ñ–¥–ø–∏—Å</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.items.map(doc => `
                    <div class="document-item">
                        <div class="document-info">
                            <h4>${getDocumentTypeLabel(doc.doc_type)}</h4>
                            <div class="document-meta">
                                ${formatDate(doc.date_start)} - ${formatDate(doc.date_end)} |
                                ${doc.days_count} –¥–Ω—ñ–≤
                            </div>
                        </div>
                        <button class="action-btn upload" onclick="openUpload(${doc.id})">
                            –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–∫–∞–Ω
                        </button>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading pending uploads:', error);
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('uk-UA', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function getDocumentTypeLabel(type) {
            const labels = {
                'vacation_paid': '–í—ñ–¥–ø—É—Å—Ç–∫–∞ –æ–ø–ª–∞—á—É–≤–∞–Ω–∞',
                'vacation_unpaid': '–í—ñ–¥–ø—É—Å—Ç–∫–∞ –±–µ–∑ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è',
                'term_extension': '–ü—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É'
            };
            return labels[type] || type;
        }

        function getStatusLabel(status) {
            const labels = {
                'draft': '–ß–µ—Ä–Ω–µ—Ç–∫–∞',
                'on_signature': '–ù–∞ –ø—ñ–¥–ø–∏—Å—ñ',
                'signed': '–ü—ñ–¥–ø–∏—Å–∞–Ω–æ',
                'processed': '–í —Ç–∞–±–µ–ª—ñ'
            };
            return labels[status] || status;
        }

        function openUpload(docId) {
            // Redirect to main upload page with document pre-selected
            window.location.href = `/portal?document_id=${docId}`;
        }
    </script>
</body>
</html>
